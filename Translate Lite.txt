// ==UserScript==
// @name         Translate Lite - VÃ• GIA AN
// @namespace    https://github.com/user
// @version      1.2
// @description  Dá»‹ch nhanh, nháº¹, khÃ´ng lag - by VÃ• GIA AN
// @author       VÃ• GIA AN
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setClipboard
// @connect      translate.googleapis.com
// @run-at       document-end
// ==/UserScript==

(function () {
  "use strict";

  if (window.top !== window.self || window.__TL__) return;
  window.__TL__ = true;

  // ===== BIáº¾N =====
  let menuOpen = false;
  let selectMode = false;
  let resultOpen = false;
  let hovered = null;
  let dragging = false;
  let dragX = 0, dragY = 0;
  let lastTranslated = "";

  // ===== Táº O HOST =====
  const host = document.createElement("div");
  document.body.appendChild(host);
  const shadow = host.attachShadow({ mode: "open" });

  // ===== CSS Tá»I GIáº¢N =====
  const css = `
    *{box-sizing:border-box;margin:0;padding:0}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999999;display:none}
    .overlay.on{display:block}
    .menu{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000000;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.3);font:14px/1.4 system-ui,sans-serif;width:400px;max-width:92vw;display:none}
    .menu.on{display:block}
    .menu-head{background:#4a5568;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center}
    .menu-head .title{display:flex;align-items:center;gap:10px}
    .menu-head h3{font-size:15px;font-weight:600}
    .menu-head .ver{background:#48bb78;color:#fff;font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600}
    .menu-head button{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;line-height:1}
    .menu-body{padding:14px 16px}
    .row{display:flex;gap:8px;margin-bottom:12px}
    .row>*{flex:1}
    label{display:block;font-size:12px;font-weight:500;color:#555;margin-bottom:4px}
    select,textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font:13px system-ui;resize:none}
    select:focus,textarea:focus{outline:none;border-color:#4a5568}
    textarea{height:80px}
    .btn{width:100%;padding:10px;border:none;border-radius:6px;font:13px/1 system-ui;font-weight:600;cursor:pointer;margin-top:4px}
    .btn-p{background:#4a5568;color:#fff}
    .btn-p:hover{background:#2d3748}
    .hint{font-size:11px;color:#888;margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap}
    .hint kbd{background:#333;color:#fff;padding:1px 5px;border-radius:3px;font:10px monospace}

    /* ===== SECTION KHOANH VÃ™NG ===== */
    .divider{border:none;border-top:1px dashed #ddd;margin:16px 0 12px}
    .section-title{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .section-title .icon{font-size:16px}
    .section-title h4{font-size:13px;font-weight:600;color:#4a5568}
    .section-title .badge{background:#48bb78;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600}
    .select-section{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px}
    .select-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .select-row>div{flex:1}
    .select-row .arrow{flex:none;color:#48bb78;font-size:18px;font-weight:bold;margin-top:18px}
    .select-row label{font-size:11px;color:#666;margin-bottom:3px;font-weight:600;text-transform:uppercase}
    .select-row select{width:100%;padding:8px 10px;border:1px solid #cbd5e1;border-radius:6px;font:12px system-ui;background:#fff;cursor:pointer}
    .select-row select:focus{outline:none;border-color:#48bb78}
    .btn-select{background:linear-gradient(135deg,#48bb78,#38a169);color:#fff;border:none;width:100%;padding:10px;border-radius:6px;font:13px system-ui;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
    .btn-select:hover{background:linear-gradient(135deg,#38a169,#2f855a)}
    .select-hint{font-size:10px;color:#718096;margin-top:8px;display:flex;align-items:center;gap:4px}
    .select-hint kbd{background:#4a5568;color:#fff;padding:1px 4px;border-radius:3px;font:9px monospace}

    .ind{position:fixed;top:15px;left:50%;transform:translateX(-50%);z-index:1000001;background:#48bb78;color:#fff;padding:8px 16px;border-radius:20px;font:12px/1 system-ui;font-weight:600;display:none}
    .ind.on{display:block}
    .result{position:fixed;z-index:1000002;background:#fff;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.3);font:13px/1.5 system-ui;width:340px;max-width:90vw;display:none}
    .result.on{display:block}
    .result-head{background:#4a5568;color:#fff;padding:10px 14px;border-radius:10px 10px 0 0;cursor:move;display:flex;justify-content:space-between;align-items:center;user-select:none}
    .result-head span{font-size:13px;font-weight:600}
    .result-head .hint-h{font-size:10px;opacity:.7;font-weight:400;margin-left:6px}
    .result-head button{background:none;border:none;color:#fff;font-size:18px;cursor:pointer}
    .result-body{padding:12px 14px}
    .box{padding:10px;border-radius:6px;margin-bottom:10px;max-height:100px;overflow-y:auto;word-break:break-word;font-size:13px}
    .box-o{background:#f7f7f7;border-left:3px solid #aaa;color:#333}
    .box-t{background:#d4fce8;border-left:4px solid #22c55e;color:#166534;font-weight:700;font-size:14px}
    .box-e{background:#fff5f5;border-left:3px solid #e53e3e;color:#c53030}
    .lbl{font-size:10px;color:#888;text-transform:uppercase;margin-bottom:4px;font-weight:600}
    .btn-row{display:flex;gap:8px;margin-top:10px}
    .btn-row button{flex:1;padding:8px;border:none;border-radius:5px;font:12px system-ui;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px}
    .btn-copy{background:#3b82f6;color:#fff}
    .btn-copy:hover{background:#2563eb}
    .btn-copy.copied{background:#22c55e}
    .btn-close{background:#eee;color:#333}
    .btn-close:hover{background:#ddd}
    .loading{text-align:center;padding:20px;color:#666}
    .spinner{width:24px;height:24px;border:3px solid #eee;border-top-color:#4a5568;border-radius:50%;animation:spin .6s linear infinite;margin:0 auto 8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);z-index:1000003;background:#333;color:#fff;padding:10px 20px;border-radius:8px;font:13px system-ui;opacity:0;transition:all .3s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  `;

  // ===== HTML Tá»I GIáº¢N =====
  const html = `
    <style>${css}</style>
    <div class="overlay" id="ov"></div>
    <div class="menu" id="menu">
      <div class="menu-head">
        <div class="title">
          <h3>ğŸŒ Dá»‹ch nhanh</h3>
          <span class="ver">VÃ• GIA AN v1.2</span>
        </div>
        <button id="closeMenu">Ã—</button>
      </div>
      <div class="menu-body">
        <div class="hint">
          <span><kbd>-</kbd> Menu</span>
          <span><kbd>J</kbd> Chá»n vÃ¹ng</span>
          <span><kbd>H</kbd> ÄÃ³ng</span>
          <span><kbd>C</kbd> Copy</span>
        </div>

        <!-- PHáº¦N Dá»ŠCH VÄ‚N Báº¢N -->
        <div class="row">
          <div>
            <label>Tá»«:</label>
            <select id="src">
              <option value="auto">Tá»± Ä‘á»™ng</option>
              <option value="vi">Tiáº¿ng Viá»‡t</option>
              <option value="en">English</option>
              <option value="zh-CN">ä¸­æ–‡</option>
              <option value="ja">æ—¥æœ¬èª</option>
              <option value="ko">í•œêµ­ì–´</option>
              <option value="fr">FranÃ§ais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
          <div>
            <label>Sang:</label>
            <select id="tgt">
              <option value="vi">Tiáº¿ng Viá»‡t</option>
              <option value="en">English</option>
              <option value="zh-CN">ä¸­æ–‡</option>
              <option value="ja">æ—¥æœ¬èª</option>
              <option value="ko">í•œêµ­ì–´</option>
              <option value="fr">FranÃ§ais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
        </div>
        <label>Nháº­p vÄƒn báº£n:</label>
        <textarea id="txt" placeholder="Nháº­p vÄƒn báº£n cáº§n dá»‹ch..."></textarea>
        <button class="btn btn-p" id="doTrans">ğŸ” Dá»‹ch vÄƒn báº£n</button>

        <!-- ÄÆ¯á»œNG PHÃ‚N CÃCH -->
        <hr class="divider">

        <!-- PHáº¦N KHOANH VÃ™NG -->
        <div class="section-title">
          <span class="icon">âœ‚ï¸</span>
          <h4>Cháº¿ Ä‘á»™ khoanh vÃ¹ng</h4>
          <span class="badge">NHANH</span>
        </div>

        <div class="select-section">
          <div class="select-row">
            <div>
              <label>ğŸ”¤ NgÃ´n ngá»¯ gá»‘c</label>
              <select id="srcSelect">
                <option value="auto">ğŸ” Tá»± Ä‘á»™ng</option>
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (ç®€)</option>
                <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹)</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
              </select>
            </div>
            <span class="arrow">â†’</span>
            <div>
              <label>ğŸ¯ Dá»‹ch sang</label>
              <select id="tgtSelect">
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (ç®€)</option>
                <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹)</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
              </select>
            </div>
          </div>
          <button class="btn-select" id="doSelect">âœ‚ï¸ Báº¯t Ä‘áº§u khoanh vÃ¹ng</button>
          <div class="select-hint">
            ğŸ’¡ Hoáº·c báº¥m <kbd>J</kbd> Ä‘á»ƒ báº­t nhanh cháº¿ Ä‘á»™ khoanh vÃ¹ng
          </div>
        </div>

      </div>
    </div>

    <div class="ind" id="ind">âœ‚ï¸ Click vÃ o vÃ¹ng cáº§n dá»‹ch | <kbd>Esc</kbd> thoÃ¡t</div>
    <div class="result" id="res">
      <div class="result-head" id="resHead">
        <span>Káº¿t quáº£ <span class="hint-h">(H Ä‘Ã³ng | C copy)</span></span>
        <button id="closeRes">Ã—</button>
      </div>
      <div class="result-body" id="resBody"></div>
    </div>
    <div class="toast" id="toast"></div>
  `;

  shadow.innerHTML = html;

  // ===== Láº¤Y ELEMENTS =====
  const $ = id => shadow.getElementById(id);
  const ov = $("ov");
  const menu = $("menu");
  const src = $("src");
  const tgt = $("tgt");
  const txt = $("txt");
  const ind = $("ind");
  const res = $("res");
  const resHead = $("resHead");
  const resBody = $("resBody");
  const toast = $("toast");
  const srcSelect = $("srcSelect");
  const tgtSelect = $("tgtSelect");

  // ===== TOAST =====
  const showToast = (msg) => {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  };

  // ===== COPY =====
  const copyResult = () => {
    if (!lastTranslated) return;

    if (typeof GM_setClipboard !== "undefined") {
      GM_setClipboard(lastTranslated);
      showToast("âœ… ÄÃ£ copy!");
      highlightCopyBtn();
    } else {
      navigator.clipboard.writeText(lastTranslated).then(() => {
        showToast("âœ… ÄÃ£ copy!");
        highlightCopyBtn();
      }).catch(() => {
        showToast("âŒ KhÃ´ng thá»ƒ copy!");
      });
    }
  };

  const highlightCopyBtn = () => {
    const copyBtn = shadow.getElementById("copyBtn");
    if (copyBtn) {
      copyBtn.classList.add("copied");
      copyBtn.innerHTML = "âœ… ÄÃ£ copy!";
      setTimeout(() => {
        copyBtn.classList.remove("copied");
        copyBtn.innerHTML = "ğŸ“‹ Copy (C)";
      }, 1500);
    }
  };

  // ===== HÃ€M =====
  const openMenu = () => { menuOpen = true; menu.classList.add("on"); ov.classList.add("on"); };
  const closeMenu = () => { menuOpen = false; menu.classList.remove("on"); ov.classList.remove("on"); };
  const toggleMenu = () => menuOpen ? closeMenu() : openMenu();

  const openRes = (x, y) => {
    resultOpen = true;
    res.classList.add("on");
    const w = 340, h = 250, p = 10;
    let l = x + p, t = y + p;
    if (l + w > innerWidth) l = x - w - p;
    if (t + h > innerHeight) t = innerHeight - h - p;
    if (l < p) l = p;
    if (t < p) t = p;
    res.style.left = l + "px";
    res.style.top = t + "px";
  };

  const openResCenter = () => {
    resultOpen = true;
    res.classList.add("on");
    res.style.left = (innerWidth - 340) / 2 + "px";
    res.style.top = (innerHeight - 250) / 2 + "px";
  };

  const closeRes = () => { resultOpen = false; res.classList.remove("on"); };

  const startSelect = () => {
    closeMenu();
    closeRes();
    selectMode = true;
    ind.classList.add("on");
    document.body.style.cursor = "crosshair";
  };

  const stopSelect = () => {
    selectMode = false;
    ind.classList.remove("on");
    document.body.style.cursor = "";
    if (hovered) { hovered.style.outline = ""; hovered = null; }
  };

  const langName = c => ({
    auto: "Tá»± Ä‘á»™ng", vi: "Tiáº¿ng Viá»‡t", en: "English",
    "zh-CN": "ä¸­æ–‡ (ç®€)", "zh-TW": "ä¸­æ–‡ (ç¹)",
    ja: "æ—¥æœ¬èª", ko: "í•œêµ­ì–´",
    fr: "FranÃ§ais", de: "Deutsch",
    es: "EspaÃ±ol", ru: "Ğ ÑƒÑÑĞºĞ¸Ğ¹", th: "à¹„à¸—à¸¢"
  })[c] || c;

  const translate = (text, sl, tl, x, y) => {
    if (x !== undefined) openRes(x, y);
    else openResCenter();

    resBody.innerHTML = `<div class="loading"><div class="spinner"></div>Äang dá»‹ch...</div>`;

    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;

    GM_xmlhttpRequest({
      method: "GET",
      url,
      onload: r => {
        try {
          const d = JSON.parse(r.responseText);
          let tr = "";
          if (d?.[0]) d[0].forEach(i => { if (i[0]) tr += i[0]; });
          const dl = d?.[2] || sl;

          if (tr) {
            lastTranslated = tr;
            resBody.innerHTML = `
              <div class="lbl">Gá»‘c (${langName(dl)})</div>
              <div class="box box-o">${esc(text)}</div>
              <div class="lbl">âœ… Báº£n dá»‹ch (${langName(tl)})</div>
              <div class="box box-t">${esc(tr)}</div>
              <div class="btn-row">
                <button class="btn-copy" id="copyBtn">ğŸ“‹ Copy (C)</button>
                <button class="btn-close" id="closeBtn">ÄÃ³ng (H)</button>
              </div>
            `;
            shadow.getElementById("copyBtn").onclick = copyResult;
            shadow.getElementById("closeBtn").onclick = closeRes;
          } else {
            showErr("KhÃ´ng thá»ƒ dá»‹ch");
          }
        } catch (e) {
          showErr("Lá»—i: " + e.message);
        }
      },
      onerror: () => showErr("Lá»—i káº¿t ná»‘i")
    });
  };

  const showErr = msg => {
    lastTranslated = "";
    resBody.innerHTML = `
      <div class="box box-e">âŒ ${esc(msg)}</div>
      <button class="btn-close" id="closeBtn" style="width:100%;margin-top:10px">ÄÃ³ng (H)</button>
    `;
    shadow.getElementById("closeBtn").onclick = closeRes;
  };

  const esc = t => {
    const d = document.createElement("div");
    d.textContent = t;
    return d.innerHTML;
  };

  // ===== EVENTS =====

  document.addEventListener("keydown", e => {
    const tag = e.target.tagName.toLowerCase();
    const edit = e.target.isContentEditable;

    if (e.key === "Escape") {
      if (selectMode) { stopSelect(); return; }
      if (resultOpen) { closeRes(); return; }
      if (menuOpen) { closeMenu(); return; }
    }

    if ((e.key === "h" || e.key === "H") && resultOpen) {
      if (tag !== "input" && tag !== "textarea" && !edit) {
        e.preventDefault();
        closeRes();
        return;
      }
    }

    if ((e.key === "c" || e.key === "C") && resultOpen) {
      if (tag !== "input" && tag !== "textarea" && !edit) {
        e.preventDefault();
        copyResult();
        return;
      }
    }

    if (tag === "input" || tag === "textarea" || edit) return;

    if (e.key === "-") {
      e.preventDefault();
      if (selectMode) stopSelect();
      if (resultOpen) closeRes();
      toggleMenu();
    }

    if (e.key === "j" || e.key === "J") {
      if (!menuOpen && !resultOpen) {
        e.preventDefault();
        selectMode ? stopSelect() : startSelect();
      }
    }
  });

  document.addEventListener("mousemove", e => {
    if (!selectMode || host.contains(e.target)) return;
    if (hovered && hovered !== e.target) hovered.style.outline = "";
    hovered = e.target;
    hovered.style.outline = "2px solid #48bb78";
  }, true);

  document.addEventListener("click", e => {
    if (!selectMode || host.contains(e.target)) return;
    e.preventDefault();
    e.stopPropagation();

    const text = e.target.innerText?.trim();
    if (!text) return;

    // DÃ¹ng ngÃ´n ngá»¯ tá»« pháº§n khoanh vÃ¹ng
    const currentSrc = srcSelect.value;
    const currentTgt = tgtSelect.value;

    stopSelect();
    translate(text, currentSrc, currentTgt, e.clientX, e.clientY);
  }, true);

  resHead.addEventListener("mousedown", e => {
    if (e.target.tagName === "BUTTON") return;
    dragging = true;
    const rect = res.getBoundingClientRect();
    dragX = e.clientX - rect.left;
    dragY = e.clientY - rect.top;
  });

  document.addEventListener("mousemove", e => {
    if (!dragging) return;
    let x = e.clientX - dragX;
    let y = e.clientY - dragY;
    x = Math.max(0, Math.min(x, innerWidth - res.offsetWidth));
    y = Math.max(0, Math.min(y, innerHeight - res.offsetHeight));
    res.style.left = x + "px";
    res.style.top = y + "px";
  });

  document.addEventListener("mouseup", () => { dragging = false; });

  $("closeMenu").onclick = closeMenu;
  $("closeRes").onclick = closeRes;
  ov.onclick = closeMenu;

  $("doTrans").onclick = () => {
    const t = txt.value.trim();
    if (!t) { txt.focus(); return; }
    closeMenu();
    translate(t, src.value, tgt.value);
  };

  $("doSelect").onclick = startSelect;

  // ===== LÆ¯U SETTINGS =====
  const savedSrc = localStorage.getItem("tl_src");
  const savedTgt = localStorage.getItem("tl_tgt");
  const savedSrcSelect = localStorage.getItem("tl_src_select");
  const savedTgtSelect = localStorage.getItem("tl_tgt_select");

  if (savedSrc) src.value = savedSrc;
  if (savedTgt) tgt.value = savedTgt;
  if (savedSrcSelect) srcSelect.value = savedSrcSelect;
  if (savedTgtSelect) tgtSelect.value = savedTgtSelect;

  src.onchange = () => localStorage.setItem("tl_src", src.value);
  tgt.onchange = () => localStorage.setItem("tl_tgt", tgt.value);
  srcSelect.onchange = () => localStorage.setItem("tl_src_select", srcSelect.value);
  tgtSelect.onchange = () => localStorage.setItem("tl_tgt_select", tgtSelect.value);

  console.log("[Translate Lite - VÃ• GIA AN v1.2] âœ“ Ready | [-] Menu | [J] Select | [H] Close | [C] Copy");
})();